<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LOTO Manager — Rettet</title>
  <style>
    :root{
      --bg:#f6f6f6; --card:#fff; --muted:#6b7280; --primary:#E30613; --green:#16a34a;
      --radius:12px; --btn-pad:12px 16px; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#efefef);color:#0b1720}
    header{background:var(--card);padding:12px 16px;display:flex;align-items:center;gap:12px;box-shadow:0 1px 0 rgba(0,0,0,0.05);position:sticky;top:0;z-index:40}
    .logo{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#ff6b6b);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    .title{font-weight:700}
    main{max-width:980px;margin:18px auto;padding:12px}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 8px 24px rgba(0,0,0,0.04)}
    .row{display:flex;gap:12px;align-items:center}
    .spacer{flex:1}
    .btn{background:var(--primary);color:#fff;padding:var(--btn-pad);border-radius:10px;border:0;cursor:pointer;font-size:1rem}
    .btn.secondary{background:#f3f4f6;color:#111;padding:var(--btn-pad)}
    .link{background:none;border:0;color:var(--primary);cursor:pointer}
    label{display:block;font-size:0.9rem;color:var(--muted);margin-bottom:6px}
    input{width:100%;padding:10px;border-radius:8px;border:1px solid #eee}
    .inline-error{color:#b91c1c;font-size:0.9rem;display:none}
    .spinner{display:inline-block;width:16px;height:16px;border:3px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;margin-left:8px;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    .muted-note{color:var(--muted);margin-top:6px}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .lock{display:grid;grid-template-columns:110px 1fr 160px 150px 110px;gap:10px;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:#fff}
    .primary{font-weight:700}
    .secondary{color:var(--muted)}
    .badge{background:var(--green);color:#fff;padding:6px 8px;border-radius:8px;font-weight:700}
    .overdue{background:#fff1f1;color:#b91c1c;padding:6px 8px;border-radius:8px;font-weight:700}
    .time-overdue{color:#b91c1c;font-weight:700}
    @media (max-width:820px){ .lock{grid-template-columns:1fr} }

    /* modal / steps */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{background:var(--card);border-radius:10px;padding:12px;width:95%;max-width:920px;max-height:90vh;overflow:auto}
    .modal-top{position:sticky;top:0;background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(255,255,255,0.95));padding:8px;display:flex;justify-content:space-between;align-items:center;gap:8px;border-bottom:1px solid rgba(0,0,0,0.03);z-index:10}
    .video-wrap{position:relative;border-radius:8px;overflow:hidden}
    video{display:block;width:100%;height:auto;background:#000;border-radius:8px}
    .scan-check{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(0.6);width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#16a34a,#4ade80);color:#fff;font-weight:700;opacity:0;transition:opacity .18s,transform .18s}
    .scan-check.show{opacity:1;transform:translate(-50%,-50%) scale(1)}
    .step{padding:12px}
    .step.hidden{display:none}
    .step-indicators{display:flex;gap:8px;margin-bottom:10px}
    .step-indicators div{width:10px;height:10px;border-radius:50%;background:#e6eef9}
    .step-indicators div.active{background:var(--primary)}
    .scanner-warning{padding:10px;border-radius:8px;background:#fff4e6;color:#92400e;margin-top:8px;border:1px solid rgba(146,64,14,0.08)}
    .photo-fallback{width:320px;height:180px;border-radius:8px;background:#fff6f6;display:flex;align-items:center;justify-content:center;color:var(--muted)}

    /* small helpers */
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <header>
    <div class="row"><div class="logo">LO</div><div class="title">LOTO Manager</div></div>
    <div class="spacer"></div>
    <div id="user-area" class="row" style="display:none"><div id="user-name" class="muted"></div><button id="signout-btn" class="link">Log ud</button></div>
  </header>

  <main>
    <!-- AUTH -->
    <section class="card" id="auth-card">
      <div style="display:flex;gap:16px;flex-wrap:wrap;">
        <div style="min-width:260px;max-width:420px">
          <h3>Log ind</h3>
          <form id="login-form">
            <label>Telefon</label>
            <input id="login-phone" type="tel" placeholder="+45 ..." />
            <label style="margin-top:8px">Kode</label>
            <input id="login-password" type="password" placeholder="Kode" />
            <div style="display:flex;align-items:center;justify-content:flex-end;margin-top:10px">
              <span id="login-error" class="inline-error"></span>
              <button id="login-btn" class="btn" type="submit">Log ind <span id="login-spinner" class="spinner" style="display:none"></span></button>
            </div>
          </form>
          <div style="margin-top:8px;display:flex;justify-content:flex-end">
            <button id="show-signup" class="link">Opret bruger</button>
          </div>
        </div>

        <div id="signup-card" style="display:none;min-width:260px;max-width:420px">
          <h3>Opret bruger</h3>
          <form id="signup-form">
            <label>Navn</label><input id="signup-name" type="text" />
            <label style="margin-top:8px">Telefon</label><input id="signup-phone" type="tel" />
            <label style="margin-top:8px">Kode</label><input id="signup-password" type="password" />
            <div style="display:flex;align-items:center;justify-content:flex-end;margin-top:10px">
              <span id="signup-error" class="inline-error"></span>
              <button id="signup-cancel" class="btn secondary" type="button">Annuller</button>
              <button id="signup-btn" class="btn" type="submit">Opret <span id="signup-spinner" class="spinner" style="display:none"></span></button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- APP -->
    <section class="card" id="app-view" style="display:none">
      <div class="row">
        <div><h2>Aktive låse</h2><div class="muted-note">Tryk på en registrering for detaljer</div></div>
        <div class="spacer"></div>
        <button id="start-loto-btn" class="btn">Start LOTO</button>
      </div>

      <div id="locks-list" class="list"></div>
    </section>
  </main>

  <!-- Modal with top controls (no separate close) -->
  <div id="modal-backdrop" class="modal-backdrop" style="display:none">
    <div class="modal">
      <div class="modal-top">
        <div><button id="prev-step" class="btn secondary" disabled>Forrige</button></div>
        <div style="display:flex;gap:8px">
          <button id="abort-step" class="btn secondary">Annuller</button>
          <button id="next-step" class="btn">Næste</button>
        </div>
      </div>

      <div class="step-indicators" style="display:flex;gap:8px;margin-bottom:10px">
        <div data-step="0" class="active" style="width:10px;height:10px;border-radius:50%;background:var(--primary)"></div>
        <div data-step="1" style="width:10px;height:10px;border-radius:50%;background:#e6eef9"></div>
        <div data-step="2" style="width:10px;height:10px;border-radius:50%;background:#e6eef9"></div>
      </div>

      <div id="step-0" class="step">
        <h3>1) Scan QR-kode</h3>
        <div style="margin-bottom:10px">
          <div class="video-wrap" style="margin-bottom:8px">
            <video id="video" playsinline autoplay muted></video>
            <div id="scan-check" class="scan-check">✓</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="start-camera" class="btn secondary">Start kamera</button>
            <button id="flip-camera" class="btn secondary">Skift kamera</button>
            <div id="camera-status" class="muted-note"></div>
          </div>
          <div id="scanner-warning" class="scanner-warning" style="display:none">BarcodeDetector ikke tilgængelig — test via Chrome/Edge eller localhost/HTTPS</div>
        </div>

        <div>
          <div class="muted-note">Hold kameraet over QR-koden. Hvis det ikke virker: indtast manuelt (kun tal).</div>
          <div style="margin-top:8px"><label>Scannet equipment</label><div id="scanned-data" style="padding:8px;background:#fff6f6;border-radius:6px">Ingen scanning endnu</div></div>
          <div style="margin-top:8px"><label>Manuel indtastning</label><input id="manual-equip" type="tel" inputmode="numeric"></div>
        </div>
      </div>

      <div id="step-1" class="step hidden">
        <h3>2) Indtast låsenummer</h3>
        <div style="margin-top:8px">
          <label>Hængelås nummer (kun tal)</label><input id="lock-number" type="tel" inputmode="numeric">
          <div class="muted-note" style="margin-top:8px">Dette nummer gemmes med registreringen.</div>
        </div>
      </div>

      <div id="step-2" class="step hidden">
        <h3>3) Tag foto</h3>
        <div style="display:flex;gap:12px;align-items:flex-start;margin-top:8px">
          <div style="flex:1">
            <img id="capture-preview" src="" style="display:none;width:100%;border-radius:8px" alt="Preview">
            <div id="photo-placeholder" class="photo-fallback">Ingen foto endnu</div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="take-photo" class="btn">Tag foto</button>
              <button id="retake-photo" class="btn secondary" style="display:none">Tag igen</button>
            </div>
            <div id="upload-status" class="muted-note" style="margin-top:8px;display:none"></div>
          </div>
          <div style="width:300px">
            <label>Operatør (valgfri)</label><input id="operator" type="text">
          </div>
        </div>
      </div>

      <canvas id="canvas" style="display:none"></canvas>
    </div>
  </div>

  <!-- Details modal -->
  <div id="details-backdrop" class="modal-backdrop" style="display:none">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Detaljer</strong></div>
        <button id="close-details" class="link">Luk</button>
      </div>
      <div id="details-content" style="margin-top:12px"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp, query, where, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCZ1l12BC2ZowpgTgyOFX7QsuD9__0omFk",
      authDomain: "loto-app-ffa5a.firebaseapp.com",
      projectId: "loto-app-ffa5a",
      storageBucket: "loto-app-ffa5a.firebasestorage.app",
      messagingSenderId: "90362528781",
      appId: "1:90362528781:web:e9809bbeb6b12160ea8144"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // utility
    const $ = id => document.getElementById(id);
    function phoneToEmail(phone){ const cleaned = (phone||'').replace(/\s+/g,'').replace(/\+/g,'plus').replace(/[^a-zA-Z0-9_-]/g,''); return `${cleaned}@loto.local`; }
    function formatTimestamp(ts){ if(!ts) return ''; try{ const d = ts.toDate ? ts.toDate() : new Date(ts); const pad = n=>String(n).padStart(2,'0'); return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }catch(e){ return ''; } }

    // DOM refs
    const loginForm = $('login-form'), loginBtn = $('login-btn'), loginSpinner = $('login-spinner'), loginError = $('login-error');
    const showSignup = $('show-signup'), signupCard = $('signup-card'), signupForm = $('signup-form'), signupBtn = $('signup-btn'), signupSpinner = $('signup-spinner'), signupError = $('signup-error'), signupCancel = $('signup-cancel');

    const authCard = $('auth-card'), appView = $('app-view'), userArea = $('user-area'), userName = $('user-name'), signoutBtn = $('signout-btn');
    const locksList = $('locks-list');

    // modal refs
    const modalBackdrop = $('modal-backdrop'), prevStepBtn = $('prev-step'), nextStepBtn = $('next-step'), abortStepBtn = $('abort-step');
    const videoEl = $('video'), scanCheck = $('scan-check'), canvas = $('canvas'), cameraStatus = $('camera-status'), scannerWarning = $('scanner-warning');
    const scannedDataEl = $('scanned-data'), manualEquip = $('manual-equip'), lockNumber = $('lock-number'), operatorField = $('operator');
    const capturePreview = $('capture-preview'), photoPlaceholder = $('photo-placeholder'), takePhotoBtn = $('take-photo'), retakePhotoBtn = $('retake-photo'), uploadStatus = $('upload-status');

    const detailsBackdrop = $('details-backdrop'), detailsContent = $('details-content'), closeDetailsBtn = $('close-details');

    // state
    let currentUser = null;
    let stream = null;
    let usingFront = false;
    let detector = null;
    let scanActive = false;
    let scanFrameId = null;
    let pendingPhotoDataUrl = null;
    let lastScannedValue = null;
    let unsubscribeLocks = null;
    let lastCreatedId = null;
    let currentStep = 0;
    const scanCtx = canvas.getContext ? canvas.getContext('2d') : null;

    // init detector
    async function initDetector(){
      try{
        if(window.BarcodeDetector){ detector = new BarcodeDetector({formats:['qr_code']}); hide($('scanner-warning')); }
        else { detector = null; show($('scanner-warning')); }
      } catch(e){ detector = null; show($('scanner-warning')); console.warn(e); }
    }
    initDetector();

    // small helpers
    function show(el){ if(el) el.style.display = ''; }
    function hide(el){ if(el) el.style.display = 'none'; }
    function setInlineError(el, msg){ if(!el) return; if(msg){ el.textContent = msg; el.style.display = 'block'; } else { el.textContent=''; el.style.display = 'none'; } }

    // auth UI
    showSignup.addEventListener('click', ()=>{ show(signupCard); hide(showSignup); });
    signupCancel.addEventListener('click', ()=>{ hide(signupCard); show(showSignup); });

    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      setInlineError(loginError,'');
      const phone = $('login-phone').value.trim(), pwd = $('login-password').value;
      if(!phone||!pwd){ setInlineError(loginError,'Udfyld telefon og kode'); return; }
      loginBtn.disabled = true; show(loginSpinner);
      try{ await signInWithEmailAndPassword(auth, phoneToEmail(phone), pwd); }
      catch(err){ console.error(err); setInlineError(loginError, err.message || 'Login fejlede'); }
      finally{ loginBtn.disabled = false; hide(loginSpinner); }
    });

    signupForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      setInlineError(signupError,'');
      const name = $('signup-name').value.trim(), phone = $('signup-phone').value.trim(), pwd = $('signup-password').value;
      if(!name||!phone||!pwd){ setInlineError(signupError,'Udfyld alle felter'); return; }
      signupBtn.disabled = true; show(signupSpinner);
      try{
        const uc = await createUserWithEmailAndPassword(auth, phoneToEmail(phone), pwd);
        await updateProfile(uc.user, { displayName: name });
        await setDoc(doc(db,'users',uc.user.uid), { name, phone, createdAt: serverTimestamp() });
        hide(signupCard); show(showSignup);
      } catch(err){ console.error(err); setInlineError(signupError, err.message || 'Oprettelse fejlede'); }
      finally{ signupBtn.disabled = false; hide(signupSpinner); }
    });

    signoutBtn.addEventListener('click', async ()=>{ try{ await signOut(auth); }catch(e){ console.error(e); alert('Log ud fejlede'); } });

    // auth state
    onAuthStateChanged(auth, user => {
      currentUser = user || null;
      if(user){
        hide(authCard); show(appView); show(userArea); userName.textContent = user.displayName || user.email || '';
        startListeningActiveLocks();
      } else {
        show(authCard); hide(appView); hide(userArea); stopListeningActiveLocks();
      }
    });

    // camera & scanning
    function safeDrawFrame(){
      if(!videoEl || !canvas || !scanCtx) return false;
      const vw = videoEl.videoWidth, vh = videoEl.videoHeight;
      if(!vw||!vh) return false;
      canvas.width = vw; canvas.height = vh; scanCtx.drawImage(videoEl,0,0,vw,vh); return true;
    }

    async function startCamera(force=false){
      try{
        if(stream && !force){ cameraStatus.textContent = 'Kamera aktiv'; startScanning(); return; }
        const constraints = { video:{ facingMode: usingFront? 'user':'environment', width:{ideal:1280}, height:{ideal:720} }, audio:false };
        if(stream) stopCamera();
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        if(videoEl){ videoEl.srcObject = stream; try{ await videoEl.play(); }catch(e){} }
        cameraStatus.textContent = 'Kamera aktiv';
        localStorage.setItem('cameraAllowed','true');
        await initDetector();
        startScanning();
      } catch(e){ console.warn(e); cameraStatus.textContent = 'Kamera ikke tilgængelig'; }
    }
    function stopCamera(){ if(stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch(e){} stream=null; } if(videoEl) videoEl.srcObject = null; cameraStatus.textContent = ''; stopScanning(); }

    async function startScanning(){
      if(!detector) return;
      if(scanActive) return;
      scanActive = true; lastScannedValue = null;
      if(videoEl.paused) try{ await videoEl.play(); }catch(e){}
      const loop = async ()=>{
        try{
          if(!safeDrawFrame()){ scanFrameId = requestAnimationFrame(loop); return; }
          try{
            const bitmap = await createImageBitmap(canvas);
            const results = await detector.detect(bitmap);
            bitmap.close();
            if(results && results.length>0){
              const v = results[0].rawValue || results[0].rawData || '';
              if(v && v !== lastScannedValue){ lastScannedValue = v; onDetectedQR(v); }
            }
          } catch(e){}
        } catch(e){ console.warn(e); }
        scanFrameId = requestAnimationFrame(loop);
      };
      scanFrameId = requestAnimationFrame(loop);
    }
    function stopScanning(){ if(scanFrameId){ cancelAnimationFrame(scanFrameId); scanFrameId=null; } scanActive=false; }

    function triggerScanAnim(){ try{ videoEl.classList.add('video-detect'); scanCheck.classList.add('show'); setTimeout(()=>videoEl.classList.remove('video-detect'),900); setTimeout(()=>scanCheck.classList.remove('show'),900); }catch(e){} }
    function onDetectedQR(value){ scannedDataEl.textContent = value; scannedDataEl.classList.remove('muted'); triggerScanAnim(); stopScanning(); setTimeout(()=>{ if(currentStep===0) goToStep(1); },600); }

    // steps
    const stepsEls = [$('step-0'), $('step-1'), $('step-2')];
    const stepIndicators = Array.from(document.querySelectorAll('.step-indicators div'));
    function goToStep(idx){
      if(idx<0||idx>2) return;
      currentStep = idx;
      stepsEls.forEach((s,i)=> s.classList.toggle('hidden', i !== idx));
      stepIndicators.forEach((d,i)=> d.classList.toggle('active', i===idx));
      $('prev-step').disabled = (idx===0);
      if(idx===2) startCamera(false).catch(()=>{});
      if(idx===0){ const pref = localStorage.getItem('cameraAllowed'); if(pref === 'true') startCamera(false).catch(()=>{}); }
    }
    goToStep(0);

    // top button handlers (prev/abort/next)
    $('next-step').addEventListener('click', async ()=>{
      if(currentStep===0){
        const scanned = scannedDataEl.textContent && scannedDataEl.textContent.trim() && scannedDataEl.textContent.trim()!=='Ingen scanning endnu' ? scannedDataEl.textContent.trim() : null;
        const manual = manualEquip.value.trim() || null;
        if(!scanned && !manual){ alert('Scan QR eller indtast equipment manuelt'); return; }
        if(!scanned && manual){ scannedDataEl.textContent = manual; scannedDataEl.classList.remove('muted'); }
        goToStep(1);
      } else if(currentStep===1){
        const ln = lockNumber.value.trim();
        if(!ln){ alert('Indtast låsens nummer'); return; }
        goToStep(2);
      } else if(currentStep===2){
        // Save: require lock and photo; operator optional
        const ln = lockNumber.value.trim();
        if(!ln){ alert('Indtast låsens nummer'); return; }
        if(!pendingPhotoDataUrl){ alert('Tag et foto før gem'); return; }
        try{
          uploadStatus.style.display = 'block'; uploadStatus.textContent = 'Opretter...';
          const op = operatorField.value.trim() || (auth.currentUser ? (auth.currentUser.displayName || '') : '');
          const sticker = scannedDataEl.textContent.trim() || manualEquip.value.trim() || '';
          const docRef = await addDoc(collection(db,'activeLocks'), {
            operatorName: op, lockNumber: ln, stickerData: sticker,
            createdBy: auth.currentUser ? auth.currentUser.uid : null,
            createdByName: auth.currentUser ? (auth.currentUser.displayName || '') : '',
            createdAt: serverTimestamp(), status: 'active'
          });
          // upload photo
          if(pendingPhotoDataUrl){
            const blob = await (await fetch(pendingPhotoDataUrl)).blob();
            const sRef = storageRef(storage, `activeLocks/${docRef.id}/photo.jpg`);
            await uploadBytes(sRef, blob);
            const url = await getDownloadURL(sRef);
            await updateDoc(docRef, { photoURL: url, photoUploadedAt: serverTimestamp() });
          }
          lastCreatedId = docRef.id; pendingPhotoDataUrl = null;
          uploadStatus.style.display = 'none';
          alert('Registrering gemt');
          closeModal();
        } catch(err){ console.error(err); uploadStatus.style.display='none'; alert('Gem fejlede: ' + (err.message || err)); }
      }
    });

    $('prev-step').addEventListener('click', ()=>{ if(currentStep>0) goToStep(currentStep-1); });
    $('abort-step').addEventListener('click', ()=>{ if(confirm('Annuller flow?')) closeModal(); });

    function closeModal(){
      if(manualEquip.value || lockNumber.value || pendingPhotoDataUrl){ if(!confirm('Du mister ændringer. Fortsæt?')) return; }
      stopCamera(); $('modal-backdrop').style.display = 'none'; goToStep(0);
    }

    $('start-loto-btn').addEventListener('click', ()=>{ $('modal-backdrop').style.display = 'flex'; goToStep(0); const pref = localStorage.getItem('cameraAllowed'); if(pref === 'true') startCamera(false).catch(()=>{}); });

    $('start-camera').addEventListener('click', async ()=>{ await initDetector(); startCamera(true); });
    $('flip-camera').addEventListener('click', async ()=>{ usingFront = !usingFront; await startCamera(true); });

    $('take-photo').addEventListener('click', async ()=>{
      if(!videoEl || !stream){ alert('Start kamera først'); return; }
      if(!canvas || !scanCtx){ alert('Canvas ikke tilgængelig'); return; }
      const vw = videoEl.videoWidth, vh = videoEl.videoHeight;
      if(!vw || !vh){ alert('Kamera ikke klar'); return; }
      canvas.width = vw; canvas.height = vh; scanCtx.drawImage(videoEl,0,0,vw,vh);
      const dataUrl = canvas.toDataURL('image/jpeg',0.9);
      pendingPhotoDataUrl = dataUrl;
      capturePreview.src = dataUrl; capturePreview.style.display = 'block';
      photoPlaceholder.style.display = 'none';
      retakePhotoBtn.style.display = 'inline-block';
    });

    $('retake-photo').addEventListener('click', ()=>{ pendingPhotoDataUrl = null; capturePreview.src=''; capturePreview.style.display='none'; photoPlaceholder.style.display='flex'; retakePhotoBtn.style.display='none'; });

    // locks list
    function startListeningActiveLocks(){
      try{
        const locksRef = collection(db,'activeLocks');
        const q = query(locksRef, where('status','==','active'));
        if(unsubscribeLocks) unsubscribeLocks();
        unsubscribeLocks = onSnapshot(q, snap => {
          const items = [];
          snap.forEach(s => items.push({ id: s.id, data: s.data() }));
          items.sort((a,b)=> {
            const ta = a.data.createdAt && a.data.createdAt.toDate ? a.data.createdAt.toDate().getTime() : 0;
            const tb = b.data.createdAt && b.data.createdAt.toDate ? b.data.createdAt.toDate().getTime() : 0;
            return tb - ta;
          });
          locksList.innerHTML = '';
          if(items.length===0){ locksList.innerHTML = '<div class="muted-note">Ingen aktive låse.</div>'; return; }
          items.forEach(item=>{
            const d = item.data; const id = item.id;
            const createdAtText = formatTimestamp(d.createdAt);
            const isOld = (Date.now() - (d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().getTime() : 0)) > (24*3600*1000);
            const el = document.createElement('div'); el.className = 'lock';
            el.innerHTML = `<div class="primary">${d.lockNumber||'—'}</div><div class="primary">${d.stickerData||'—'}</div><div class="primary">${d.operatorName||''}</div><div class="primary ${isOld?'time-overdue':''}">${createdAtText||'—'}</div><div><div class="badge">AKTIV</div>${isOld?'<div class="overdue">Over 24h</div>':''}</div>`;
            el.addEventListener('click', ()=> openDetails(id));
            locksList.appendChild(el);
          });
        }, err => console.error('locks snapshot err', err));
      } catch(e){ console.error(e); locksList.innerHTML = '<div class="muted-note">Fejl ved hentning</div>'; }
    }
    function stopListeningActiveLocks(){ if(unsubscribeLocks) unsubscribeLocks(); unsubscribeLocks=null; locksList.innerHTML=''; }

    async function openDetails(id){
      try{
        const snap = await getDoc(doc(db,'activeLocks',id));
        if(!snap.exists()){ alert('Ingen data'); return; }
        const d = snap.data();
        let photoHtml = '<div>Ingen foto</div>';
        if(d.photoURL){ photoHtml = `<img src="${d.photoURL}" style="max-width:100%;border-radius:8px">`; }
        else {
          try{ const url = await getDownloadURL(storageRef(storage, `activeLocks/${id}/photo.jpg`)); if(url) photoHtml = `<img src="${url}" style="max-width:100%;border-radius:8px">`; } catch(e){}
        }
        detailsContent.innerHTML = `<div><strong>Låsenr:</strong> ${d.lockNumber||'—'}</div><div><strong>Equipment:</strong> ${d.stickerData||'—'}</div><div><strong>Operatør:</strong> ${d.operatorName||'—'}</div><div><strong>Registreret:</strong> ${formatTimestamp(d.createdAt)||'—'}</div><div style="margin-top:8px">${photoHtml}</div>`;
        detailsBackdrop.style.display = 'flex';
      } catch(e){ console.error(e); alert('Fejl ved hentning'); }
    }
    closeDetailsBtn.addEventListener('click', ()=> detailsBackdrop.style.display = 'none');

    // enforce digits
    function enforceDigits(el){ if(!el) return; el.addEventListener('input', ()=>{ el.value = (el.value||'').replace(/\D+/g,''); }); }
    enforceDigits(manualEquip); enforceDigits(lockNumber);

    // init log
    console.log('LOTO Manager ready — test via http(s)/localhost for camera/scanner.');

  </script>
</body>
</html>
