<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LOTO Manager — ROCKWOOL (rettet)</title>
  <style>
    :root{
      --bg: #f6f6f6;
      --card: #ffffff;
      --muted: #6b7280;
      --primary: #E30613;
      --green: #16a34a;
      --radius: 12px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#f1f1f1);color:#0f172a;-webkit-font-smoothing:antialiased;}
    header{background:var(--card);padding:12px 16px;display:flex;align-items:center;gap:12px;box-shadow:0 1px 0 rgba(15,23,42,0.04);position:sticky;top:0;z-index:30}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#ff6b6b);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    .title{font-size:1rem;font-weight:700}
    main{max-width:980px;margin:20px auto;padding:12px}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:14px;box-shadow:0 6px 18px rgba(15,23,42,0.04)}
    .row{display:flex;align-items:center;gap:12px}
    .spacer{flex:1}
    /* BUTTONS: larger top controls for easier tapping */
    .btn{background:var(--primary);color:#fff;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-size:1rem}
    .btn.secondary{background:#f3f4f6;color:#111;padding:10px 14px;border-radius:10px}
    .linklike{background:none;border:0;color:var(--muted);cursor:pointer;padding:8px;border-radius:8px}
    .muted{color:var(--muted)}
    .big{font-size:1.25rem;font-weight:700}
    .small{font-size:0.85rem;color:var(--muted)}

    /* list */
    .list { display:flex; flex-direction:column; gap:8px; margin-top:12px; padding:0; }
    .lock { display:grid; grid-template-columns: 120px 1fr 180px 160px 120px; gap:12px; align-items:center; padding:12px; border-radius:10px; border:1px solid rgba(15,23,42,0.06); background:linear-gradient(180deg,#ffffff,#fff6f6); cursor:pointer; transition:box-shadow .18s ease, transform .08s ease; position:relative; overflow:hidden;}
    .badge { background:var(--green); color:#fff; padding:6px 8px; border-radius:8px; font-weight:700; font-size:0.8rem; text-align:center; }
    .overdue-badge { background:#fff1f1; color:#b91c1c; padding:6px 8px; border-radius:8px; font-weight:700; font-size:0.8rem; margin-left:8px; border:1px solid rgba(185,28,28,0.08); }
    .time-overdue { color:#b91c1c; font-weight:700; }
    @media (max-width:820px) { .lock { grid-template-columns: 1fr; align-items:flex-start; gap:8px; } .lock .badge, .overdue-badge { justify-self:flex-start; } }

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.4);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal-content{background:var(--card);border-radius:12px;padding:12px;max-width:920px;width:94%;max-height:90vh;overflow:auto;position:relative}
    .modal-top-controls{ position: sticky; top: 0; background: linear-gradient(180deg,rgb(255 255 255 / 98%),rgb(255 255 255 / 95%)); padding:8px 0; display:flex; gap:8px; align-items:center; z-index:11; border-bottom:1px solid rgba(0,0,0,0.03); margin-bottom:8px; justify-content:space-between;}
    .modal-top-controls .left, .modal-top-controls .right { display:flex; gap:8px; align-items:center;}
    .modal-top-controls .close-link{ color:var(--muted); padding:6px 10px; border-radius:8px; background:transparent; border:0; cursor:pointer }
    .video-wrap{position:relative;border-radius:8px;overflow:hidden;display:inline-block;border:2px solid rgba(0,0,0,0.06)}
    video{display:block;max-width:100%;border-radius:8px;background:#000}
    canvas{display:none}
    .muted-note{color:var(--muted);font-size:0.9rem}
    .photo-fallback{width:320px;height:180px;border-radius:8px;background:#fff6f6;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:0.95rem}

    /* scan feedback */
    .video-detect { animation: scanPulse 900ms ease-out; box-shadow: 0 8px 24px rgba(34,197,94,0.12), 0 0 0 4px rgba(34,197,94,0.18); transform-origin:center; }
    @keyframes scanPulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    .scan-check { position:absolute; left:50%; top:50%; width:64px; height:64px; transform:translate(-50%,-50%) scale(0.6); border-radius:50%; display:flex;align-items:center;justify-content:center; color:#fff; font-weight:700; font-size:20px; background:linear-gradient(135deg,#16a34a,#4ade80); opacity:0; pointer-events:none; transition:opacity .18s ease, transform .28s cubic-bezier(.2,.9,.2,1); box-shadow:0 8px 20px rgba(16,185,129,0.18); }
    .scan-check.show { opacity:1; transform:translate(-50%,-50%) scale(1); }

    /* steps */
    .step { padding:12px; }
    .step.hidden { display:none; }
    .step-indicators{display:flex;gap:8px;margin-bottom:10px}
    .step-indicator{width:10px;height:10px;border-radius:50%;background:#e6eef9}
    .step-indicator.active{background:var(--primary)}
    input[type="tel"]{padding:8px;border-radius:8px;border:1px solid #f1dede;width:100%}
    .scanner-warning { padding:10px;border-radius:8px;background:#fff4e6;color:#92400e;margin-top:8px;border:1px solid rgba(146,64,14,0.08) }
  </style>
</head>
<body>
  <header>
    <div class="brand"><div class="logo">LO</div><div><div class="title">LOTO Manager</div><div class="tiny">Udviklet i Vamdrup</div></div></div>
    <div class="spacer"></div>
    <div id="user-area" style="display:none" class="center"><div id="user-name" class="muted" style="margin-right:12px"></div><button id="signout-btn" class="linklike">Log ud</button></div>
  </header>

  <main>
    <div id="auth-card" class="card">
      <form id="signup-form">
        <div class="form-row"><label>Navn</label><input id="input-name" type="text" required></div>
        <div class="form-row"><label>Kode</label><input id="input-password" type="password" required></div>
        <div class="form-row"><label>Telefon</label><input id="input-phone" type="tel" required></div>
        <div class="row"><div class="spacer"></div><button class="btn" type="submit">Opret bruger og log ind</button></div>
      </form>
      <hr/>
      <form id="login-form">
        <div class="form-row"><label>Telefon</label><input id="login-phone" type="tel" required></div>
        <div class="form-row"><label>Kode</label><input id="login-password" type="password" required></div>
        <div class="row"><div class="spacer"></div><button class="btn secondary" type="submit">Log ind</button></div>
      </form>
    </div>

    <div id="app-view" style="display:none" class="card">
      <div class="row">
        <div><div class="big">Aktive låse</div><div class="muted">Tryk på en registrering for detaljer</div></div>
        <div class="spacer"></div>
        <button id="start-loto-btn" class="btn">Start LOTO</button>
      </div>
      <div id="locks-list" class="list"></div>
    </div>
  </main>

  <!-- Modal -->
  <div id="modal" class="modal-backdrop" style="display:none" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-top-controls">
        <div class="left">
          <button id="top-prev-step" class="btn secondary" disabled>Forrige</button>
          <button id="close-modal" class="close-link" title="Luk dialog">Luk</button>
        </div>
        <div class="right">
          <button id="top-abort-step" class="btn secondary">Annuller</button>
          <button id="top-next-step" class="btn">Næste</button>
        </div>
      </div>

      <div class="step-indicators" aria-hidden="true">
        <div class="step-indicator" data-step="0"></div>
        <div class="step-indicator" data-step="1"></div>
        <div class="step-indicator" data-step="2"></div>
      </div>

      <!-- STEPS -->
      <div id="step-0" class="step">
        <div style="font-weight:700;margin-bottom:6px">1. Scan QR-koden på label til Equipment-nummeret</div>

        <div style="margin-bottom:10px">
          <div class="video-wrap" id="video-wrap" style="width:100%">
            <video id="video" playsinline autoplay muted></video>
            <div id="scan-check" class="scan-check" aria-hidden="true">✓</div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="enable-camera" class="btn secondary">Start kamera</button>
            <button id="flip-camera" class="btn secondary">Skift kamera</button>
            <div id="camera-status" class="muted-note" style="align-self:center;margin-left:8px"></div>
          </div>
          <div id="scanner-support-warning" class="scanner-warning" style="display:none;margin-top:8px">Din browser understøtter ikke BarcodeDetector — brug manuel indtastning eller kør siden via http(s) / localhost.</div>
        </div>

        <div style="margin-top:8px">
          <div class="muted-note" style="margin-bottom:8px">Hold kameraet over QR-koden. Hvis det ikke virker, indtast nummer manuelt (kun tal).</div>
          <div style="margin-bottom:8px">
            <div style="margin-bottom:6px">Scannet equipment:</div>
            <div id="scanned-data" style="padding:10px;background:#fff6f6;border-radius:8px;min-height:48px" class="muted">Ingen scanning endnu</div>
          </div>
          <div>
            <label>Manuel indtastning (kun tal)</label>
            <input id="manual-equip" type="tel" inputmode="numeric" pattern="\d*" placeholder="Equipment-nummer" style="width:100%;margin-top:6px" />
          </div>
        </div>
      </div>

      <div id="step-1" class="step hidden">
        <div style="font-weight:700;margin-bottom:6px">2. Indtast nummeret på hængelåsen du bruger/har hængt på</div>
        <div style="margin-top:10px">
          <label>Hængelås nummer (kun tal)</label>
          <input id="lock-number-step" type="tel" inputmode="numeric" pattern="\d*" placeholder="F.eks. 12345" style="width:100%;padding:8px;margin-top:8px;border-radius:8px;border:1px solid #f1dede" />
          <div id="lock-note" class="muted-note" style="margin-top:8px">Dette nummer gemmes med LOTO-registreringen.</div>
        </div>
      </div>

      <div id="step-2" class="step hidden">
        <div style="font-weight:700;margin-bottom:6px">3. Tag billede af hængelåsen hvor du har igangsat LOTO</div>
        <div style="display:flex;gap:12px;align-items:flex-start;">
          <div style="flex:1">
            <img id="capture-preview" src="" alt="Preview" style="display:none;width:100%;height:auto;border-radius:8px;background:#fff6f6" />
            <div id="photo-placeholder" class="photo-fallback" style="display:flex;align-items:center;justify-content:center">Ingen foto endnu</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="take-photo-btn" class="btn">Tag foto</button>
              <button id="retake-photo" class="btn secondary" style="display:none">Tag igen</button>
            </div>
            <div id="upload-status" style="display:none;margin-top:8px" class="muted-note"></div>
          </div>

          <div style="width:320px;min-width:220px;">
            <div class="muted-note">Sørg for at låsen er synlig og nummeret kan aflæses på billedet.</div>
            <div style="margin-top:12px">
              <label>Operatør (auto)</label>
              <input id="operator-name" type="text" style="width:100%;margin-top:6px" />
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- details modal omitted for brevity, unchanged -->

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp, query, where, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCZ1l12BC2ZowpgTgyOFX7QsuD9__0omFk",
      authDomain: "loto-app-ffa5a.firebaseapp.com",
      projectId: "loto-app-ffa5a",
      storageBucket: "loto-app-ffa5a.firebasestorage.app",
      messagingSenderId: "90362528781",
      appId: "1:90362528781:web:e9809bbeb6b12160ea8144"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const $ = id => document.getElementById(id);
    function formatTimestamp(ts){ if(!ts) return ''; try{ const d = ts.toDate ? ts.toDate() : new Date(ts); const pad = n=>String(n).padStart(2,'0'); return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }catch(e){ return ''; } }

    // DOM refs (same as earlier)
    const userNameEl = $('user-name');
    const startBtn = $('start-loto-btn');
    const modal = $('modal');
    const topNext = $('top-next-step'), topPrev = $('top-prev-step'), topAbort = $('top-abort-step'), closeModalBtn = $('close-modal');
    const video = $('video'), scanCheck = $('scan-check'), canvas = $('canvas'), cameraStatus = $('camera-status'), scannerWarning = $('scanner-support-warning');
    const scannedDataEl = $('scanned-data'), manualEquip = $('manual-equip'), lockNumber = $('lock-number-step'), operatorName = $('operator-name');
    const capturePreview = $('capture-preview'), photoPlaceholder = $('photo-placeholder'), takePhotoBtn = $('take-photo-btn'), retakePhotoBtn = $('retake-photo');
    const locksListEl = $('locks-list');

    let currentUser = null, stream = null, usingFront = false, unsubscribeLocks = null, lastCreatedId = null;
    let pendingPhotoDataUrl = null, lastScannedValue = null;

    // scanning
    let detector = null, scanActive = false, scanFrameId = null;
    const scanCtx = canvas ? canvas.getContext('2d') : null;

    async function initDetector(){
      try{
        if(window.BarcodeDetector){
          detector = new BarcodeDetector({formats:['qr_code']});
          scannerWarning && (scannerWarning.style.display = 'none');
        } else {
          detector = null;
          scannerWarning && (scannerWarning.style.display = 'block');
        }
      } catch(e){ detector = null; scannerWarning && (scannerWarning.style.display = 'block'); console.warn(e); }
    }
    initDetector();

    function triggerScanAnimation(){ try{ if(!video) return; video.classList.add('video-detect'); scanCheck.classList.add('show'); setTimeout(()=>video.classList.remove('video-detect'),900); setTimeout(()=>scanCheck.classList.remove('show'),900);}catch(e){console.warn(e);} }

    // ensure canvas exists before using
    function safeDrawFrame(){
      if(!canvas || !scanCtx || !video) return false;
      const vw = video.videoWidth, vh = video.videoHeight;
      if(!vw || !vh) return false;
      canvas.width = vw;
      canvas.height = vh;
      scanCtx.drawImage(video,0,0,vw,vh);
      return true;
    }

    async function startCamera(forcePrompt=false){
      try{
        if(stream && !forcePrompt){ cameraStatus && (cameraStatus.textContent='Kamera aktiv'); startScanning(); return; }
        const constraints = { video:{ facingMode: usingFront ? 'user' : 'environment', width:{ideal:1280}, height:{ideal:720} }, audio:false };
        if(stream) stopCamera();
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        if(video){ video.srcObject = stream; try{ await video.play(); }catch(e){} }
        cameraStatus && (cameraStatus.textContent='Kamera aktiv');
        localStorage.setItem('cameraAllowed','true');
        await initDetector(); // re-init detector after permission
        startScanning();
      } catch(e){ console.warn('startCamera err', e); cameraStatus && (cameraStatus.textContent='Kamera ikke tilgængelig'); }
    }
    function stopCamera(){ if(stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch(e){} stream=null; } if(video) video.srcObject = null; cameraStatus && (cameraStatus.textContent=''); stopScanning(); }

    async function startScanning(){
      if(!detector){ console.debug('No detector available'); return; }
      if(!video || !canvas || !scanCtx) return;
      if(scanActive) return;
      scanActive = true; lastScannedValue = null;
      if(video.paused) try{ await video.play(); }catch(e){}
      const loop = async ()=>{
        try{
          if(!safeDrawFrame()){ scanFrameId = requestAnimationFrame(loop); return; }
          try{
            const bitmap = await createImageBitmap(canvas);
            const results = await detector.detect(bitmap);
            bitmap.close();
            if(results && results.length>0){
              const v = results[0].rawValue || results[0].rawData || '';
              if(v && v !== lastScannedValue){ lastScannedValue = v; onDetectedQR(v); }
            }
          } catch(e){
            // detect may throw; ignore
          }
        } catch(e){ console.warn('scan loop err', e); }
        scanFrameId = requestAnimationFrame(loop);
      };
      scanFrameId = requestAnimationFrame(loop);
    }
    function stopScanning(){ if(scanFrameId){ cancelAnimationFrame(scanFrameId); scanFrameId = null; } scanActive = false; }

    function onDetectedQR(value){
      scannedDataEl.textContent = value;
      scannedDataEl.classList.remove('muted'); scannedDataEl.classList.add('scan-success');
      triggerScanAnimation();
      stopScanning();
      setTimeout(()=>{ if(stepIndex === 0) showStep(1); }, 600);
    }

    // list locks
    function startListeningActiveLocks(){
      try{
        const locksRef = collection(db,'activeLocks');
        const q = query(locksRef, where('status','==','active'));
        if(unsubscribeLocks) unsubscribeLocks();
        unsubscribeLocks = onSnapshot(q, snapshot => {
          const items = [];
          snapshot.forEach(s => items.push({ id: s.id, data: s.data() }));
          items.sort((a,b)=> {
            const ta = a.data.createdAt && a.data.createdAt.toDate ? a.data.createdAt.toDate().getTime() : 0;
            const tb = b.data.createdAt && b.data.createdAt.toDate ? b.data.createdAt.toDate().getTime() : 0;
            return tb - ta;
          });
          locksListEl.innerHTML = '';
          if(items.length === 0){ locksListEl.innerHTML = '<div class="muted">Ingen aktive låse.</div>'; return; }
          items.forEach(item => {
            const d = item.data; const id = item.id;
            const createdAtText = formatTimestamp(d.createdAt);
            const createdAtMs = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().getTime() : 0;
            const isOld = (Date.now() - createdAtMs) > (24*3600*1000);
            const el = document.createElement('div');
            el.className = 'lock';
            el.dataset.lockId = id;
            el.innerHTML = `
              <div class="col col-lock"><div class="primary">${d.lockNumber||'—'}</div><div class="secondary">Låsenr.</div></div>
              <div class="col col-sticker"><div class="primary">${d.stickerData||'—'}</div><div class="secondary">Equipment</div></div>
              <div class="col col-operator"><div class="primary">${d.operatorName||''}</div><div class="secondary">Registreret af</div></div>
              <div class="col col-time"><div class="primary ${isOld ? 'time-overdue' : ''}">${createdAtText||'—'}</div><div class="secondary">Tidspunkt</div></div>
              <div class="col col-badge"><div class="badge">AKTIV</div>${isOld?'<span class="overdue-badge">Over 24h</span>':''}</div>
            `;
            el.setAttribute('role','button'); el.setAttribute('tabindex','0');
            el.addEventListener('click', ()=> openLockDetails(id));
            locksListEl.appendChild(el);
          });
        }, err => console.error('locks snapshot err', err));
      } catch(e){ console.error('startListeningActiveLocks err', e); locksListEl.innerHTML = '<div class="muted">Fejl ved hentning af låse</div>'; }
    }
    function stopListeningActiveLocks(){ if(unsubscribeLocks) unsubscribeLocks(); unsubscribeLocks = null; locksListEl.innerHTML=''; }

    // open details (omitted for brevity, keep same as before)
    async function openLockDetails(id){
      // same logic as before...
      alert('Åbner detaljer for ' + id);
    }

    // Stepper
    function showStep(idx){
      if(idx<0||idx>2) return;
      stepIndex = idx;
      steps.forEach((s,i)=> s.classList.toggle('hidden', i !== idx));
      indicators.forEach((ind,i)=> ind.classList.toggle('active', i===idx));
      topPrev.disabled = (idx === 0);
      // auto-start camera for step 2 (photo)
      if(idx === 2){
        // ensure camera is started for photo
        startCamera(false).catch(()=>{ /* ignore */ });
      }
      if(idx === 0){
        // if returning to scan step and camera previously allowed, restart scanning
        const pref = localStorage.getItem('cameraAllowed');
        if(pref === 'true') startCamera(false).catch(()=>{});
      }
    }

    // enforce digits only
    function enforceDigitsOnly(el){ if(!el) return; el.addEventListener('input', ()=>{ const v = el.value.replace(/\D+/g,''); if(el.value !== v) el.value = v; }); el.addEventListener('keydown', (e)=>{ if(e.key==='Enter') e.preventDefault(); }); }
    enforceDigitsOnly(manualEquip); enforceDigitsOnly(lockNumber);

    // top buttons
    topNext?.addEventListener('click', async ()=>{
      if(stepIndex === 0){
        const scanned = scannedDataEl && scannedDataEl.textContent && scannedDataEl.textContent.trim() && scannedDataEl.textContent.trim()!=='Ingen scanning endnu' ? scannedDataEl.textContent.trim() : null;
        const manual = manualEquip && manualEquip.value.trim() ? manualEquip.value.trim() : null;
        if(!scanned && !manual){ alert('Scan QR eller indtast equipment-nummer manuelt for at fortsætte.'); return; }
        if(!scanned && manual){ scannedDataEl.textContent = manual; scannedDataEl.classList.remove('muted'); scannedDataEl.classList.add('scan-success'); }
        showStep(1);
      } else if(stepIndex === 1){
        const ln = lockNumber.value.trim();
        if(!ln){ alert('Indtast låsens nummer for at fortsætte.'); return; }
        showStep(2);
      } else if(stepIndex === 2){
        // Ensure we have a photo
        if(!pendingPhotoDataUrl){ alert('Tag et foto før du gemmer.'); return; }
        // Save flow (same checks as before)...
        alert('Gemmer... (her vil upload køre)');
      }
    });

    topPrev?.addEventListener('click', ()=>{ if(stepIndex>0) showStep(stepIndex-1); });
    topAbort?.addEventListener('click', ()=>{ if(confirm('Vil du annullere flowet?')) { modal.style.display='none'; stopCamera(); showStep(0); } });

    // camera buttons
    $('enable-camera')?.addEventListener('click', async ()=>{ await initDetector(); startCamera(true); });
    $('flip-camera')?.addEventListener('click', async ()=>{ usingFront = !usingFront; await startCamera(true); });

    // take photo
    takePhotoBtn?.addEventListener('click', async ()=>{
      if(!video || !stream){ alert('Start kamera først'); return; }
      const vw = video.videoWidth, vh = video.videoHeight;
      if(!vw || !vh){ alert('Kamera ikke klar'); return; }
      if(!canvas || !scanCtx){ alert('Canvas ikke tilgængelig'); return; }
      canvas.width = vw; canvas.height = vh;
      scanCtx.drawImage(video,0,0,vw,vh);
      const dataUrl = canvas.toDataURL('image/jpeg',0.9);
      pendingPhotoDataUrl = dataUrl;
      capturePreview.src = dataUrl; capturePreview.style.display = 'block';
      photoPlaceholder.style.display = 'none';
      retakePhotoBtn.style.display = 'inline-block';
    });

    // retake
    retakePhotoBtn?.addEventListener('click', ()=>{ pendingPhotoDataUrl = null; capturePreview.src=''; capturePreview.style.display='none'; photoPlaceholder.style.display='flex'; retakePhotoBtn.style.display='none'; });

    // start app
    startBtn?.addEventListener('click', ()=> {
      modal.style.display='flex'; showStep(0); const pref = localStorage.getItem('cameraAllowed'); if(pref==='true') startCamera(false);
    });

    // auth and listing simplified (full auth logic assumed present)
    onAuthStateChanged(auth, user => {
      currentUser = user || null;
      if(user){ userNameEl.textContent = user.displayName || user.email || ''; startListeningActiveLocks(); } else { userNameEl.textContent=''; stopListeningActiveLocks(); }
    });

    console.log('Patched app loaded — fixes applied. Important: test via HTTP/localhost, not file:// for BarcodeDetector.');
  </script>
</body>
</html>
