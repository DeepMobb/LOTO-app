<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LOTO Manager — ROCKWOOL</title>

  <style>
    :root{
      --bg: #f6f6f6;
      --card: #ffffff;
      --muted: #6b7280;
      --primary: #E30613; /* ROCKWOOL red */
      --green: #16a34a;
      --accent: #ffeeef;
      --radius: 12px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#f1f1f1);color:#0f172a;-webkit-font-smoothing:antialiased;}
    header{background:var(--card);padding:12px 16px;display:flex;align-items:center;gap:12px;box-shadow:0 1px 0 rgba(15,23,42,0.04);position:sticky;top:0;z-index:30}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#ff6b6b);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    .title{font-size:1rem;font-weight:700}
    main{max-width:980px;margin:20px auto;padding:12px}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:14px;box-shadow:0 6px 18px rgba(15,23,42,0.04)}
    .row{display:flex;align-items:center;gap:12px}
    .spacer{flex:1}
    .btn{background:var(--primary);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn.secondary{background:#f3f4f6;color:#111}
    .linklike{background:none;border:0;color:var(--primary);cursor:pointer}
    .muted{color:var(--muted)}
    .big{font-size:1.25rem;font-weight:700}
    .small{font-size:0.85rem;color:var(--muted)}

    /* LIST */
    .list { display:flex; flex-direction:column; gap:8px; margin-top:12px; padding:0; }
    .lock {
      display:grid;
      grid-template-columns: 120px 1fr 180px 160px 120px;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius:10px;
      border:1px solid rgba(15,23,42,0.06);
      background:linear-gradient(180deg,#ffffff,#fff6f6);
      cursor:pointer;
      transition:box-shadow .18s ease, transform .08s ease;
      position:relative;
      overflow:hidden;
    }
    .lock:hover { transform:translateY(-3px); box-shadow:0 8px 18px rgba(15,23,42,0.06); }
    .lock .col { display:flex; flex-direction:column; gap:4px; }
    .lock .col .primary { font-weight:700; }
    .lock .col .secondary { color:var(--muted); font-size:0.9rem; }
    .badge { background:var(--green); color:#fff; padding:6px 8px; border-radius:8px; font-weight:700; font-size:0.8rem; text-align:center; display:inline-block; }
    .overdue-badge { background:#fff1f1; color:#b91c1c; padding:6px 8px; border-radius:8px; font-weight:700; font-size:0.8rem; margin-left:8px; border:1px solid rgba(185,28,28,0.08); }
    .time-overdue { color:#b91c1c; font-weight:700; }
    .highlight{box-shadow:0 6px 18px rgba(227,6,19,0.12);border:2px solid rgba(227,6,19,0.08)}
    @media (max-width:820px) {
      .lock { grid-template-columns: 1fr; align-items:flex-start; gap:8px; }
      .lock .badge, .overdue-badge { justify-self:flex-start; }
    }

    /* Modal / camera */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.4);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal-content{background:var(--card);border-radius:12px;padding:16px;max-width:920px;width:94%;max-height:90vh;overflow:auto}
    .video-wrap{position:relative;border-radius:8px;overflow:hidden;display:inline-block;border:2px solid rgba(0,0,0,0.06)}
    video{display:block;max-width:100%;border-radius:8px;background:#000}
    img{max-width:100%;border-radius:8px}
    canvas{display:none}
    .muted-note{color:var(--muted);font-size:0.9rem}
    .photo-fallback{width:320px;height:180px;border-radius:8px;background:#fff6f6;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:0.95rem}

    /* scan feedback */
    .video-detect { animation: scanPulse 900ms ease-out; box-shadow: 0 8px 24px rgba(34,197,94,0.12), 0 0 0 4px rgba(34,197,94,0.18); transform-origin:center; }
    @keyframes scanPulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    .scan-check { position:absolute; left:50%; top:50%; width:64px; height:64px; transform:translate(-50%,-50%) scale(0.6); border-radius:50%; display:flex;align-items:center;justify-content:center; color:#fff; font-weight:700; font-size:20px; background:linear-gradient(135deg,#16a34a,#4ade80); opacity:0; pointer-events:none; transition:opacity .18s ease, transform .28s cubic-bezier(.2,.9,.2,1); box-shadow:0 8px 20px rgba(16,185,129,0.18); }
    .scan-check.show { opacity:1; transform:translate(-50%,-50%) scale(1); }

    /* Stepper */
    .steps { position:relative; overflow:hidden; min-height:260px; }
    .step { position:absolute; inset:0; opacity:0; transform:translateX(20px); transition:opacity .35s ease, transform .35s ease; padding:12px; pointer-events: none; z-index: 1; }
    .step.active { opacity:1; transform:translateX(0); position:relative; pointer-events: auto; z-index: 2; }
    .step-indicators{display:flex;gap:8px;margin-bottom:10px}
    .step-indicator{width:10px;height:10px;border-radius:50%;background:#e6eef9}
    .step-indicator.active{background:var(--primary)}
    input[type="text"], input[type="tel"], input[type="password"]{padding:8px;border-radius:8px;border:1px solid #f1dede;width:100%}

    /* info about barcode support */
    .scanner-warning { padding:10px;border-radius:8px;background:#fff4e6;color:#92400e;margin-top:8px;border:1px solid rgba(146,64,14,0.08) }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">LO</div>
      <div>
        <div class="title">LOTO Manager</div>
        <div class="tiny">Udviklet i Vamdrup</div>
      </div>
    </div>
    <div class="spacer"></div>
    <div id="user-area" style="display:none" class="center">
      <div id="user-name" class="muted" style="margin-right:12px"></div>
      <button id="signout-btn" class="linklike">Log ud</button>
    </div>
  </header>

  <main>
    <div id="auth-card" class="card">
      <form id="signup-form">
        <div class="form-row"><label>Navn</label><input id="input-name" type="text" required></div>
        <div class="form-row"><label>Kode</label><input id="input-password" type="password" required></div>
        <div class="form-row"><label>Telefon</label><input id="input-phone" type="tel" required></div>
        <div class="row"><div class="spacer"></div><button class="btn" type="submit">Opret bruger og log ind</button></div>
      </form>

      <hr/>

      <form id="login-form">
        <div class="form-row"><label>Telefon</label><input id="login-phone" type="tel" required></div>
        <div class="form-row"><label>Kode</label><input id="login-password" type="password" required></div>
        <div class="row"><div class="spacer"></div><button class="btn secondary" type="submit">Log ind</button></div>
      </form>
    </div>

    <div id="app-view" style="display:none" class="card">
      <div class="row">
        <div>
          <div class="big">Aktive låse</div>
          <div class="muted">Tryk på en registrering for detaljer</div>
        </div>
        <div class="spacer"></div>
        <button id="start-loto-btn" class="btn">Start LOTO</button>
      </div>
      <div id="locks-list" class="list"></div>
    </div>
  </main>

  <!-- STEP MODAL -->
  <div id="modal" class="modal-backdrop" style="display:none" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div id="modal-title" style="font-weight:700">Start LOTO</div>
        <button id="close-modal" class="linklike">Luk</button>
      </div>

      <div class="step-indicators" aria-hidden="true">
        <div class="step-indicator" data-step="0"></div>
        <div class="step-indicator" data-step="1"></div>
        <div class="step-indicator" data-step="2"></div>
      </div>

      <div class="steps">
        <div id="step-0" class="step active">
          <div style="font-weight:700;margin-bottom:6px">1. Scan QR-koden på label til Equipment-nummeret</div>
          <div style="display:flex;gap:12px;align-items:flex-start;">
            <div style="flex:1;">
              <div class="video-wrap" id="video-wrap">
                <video id="video" playsinline autoplay muted style="width:100%;height:auto;background:#000;border-radius:8px"></video>
                <div id="scan-check" class="scan-check" aria-hidden="true">✓</div>
              </div>
              <div id="video-fallback" class="muted-note" style="display:none;margin-top:6px">Kamera ikke tilgængeligt</div>
              <canvas id="canvas" style="display:none"></canvas>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="enable-camera" class="btn secondary">Start kamera</button>
                <button id="flip-camera" class="btn secondary">Skift kamera</button>
                <div id="camera-status" class="muted-note" style="align-self:center;margin-left:8px"></div>
              </div>
              <div id="scanner-support-warning" class="scanner-warning" style="display:none;margin-top:8px">
                Din browser understøtter ikke automatisk QR-scanning (BarcodeDetector). Brug manuel indtastning i stedet.
              </div>
            </div>

            <div style="width:320px;min-width:220px;">
              <div style="margin-bottom:8px">Scannet equipment:</div>
              <div id="scanned-data" style="padding:10px;background:#fff6f6;border-radius:8px;min-height:48px" class="muted">Ingen scanning endnu</div>
              <div id="scan-hint" class="muted-note" style="margin-top:8px">Hold kameraet over QR-koden. Hvis det ikke virker, indtast nummer manuelt.</div>
              <div style="margin-top:8px">
                <label>Manuel indtastning</label>
                <input id="manual-equip" type="text" placeholder="Equipment-nummer" style="width:100%;margin-top:6px" />
              </div>
            </div>
          </div>
        </div>

        <div id="step-1" class="step">
          <div style="font-weight:700;margin-bottom:6px">2. Indtast nummeret på hængelåsen du bruger/har hængt på</div>
          <div style="margin-top:10px">
            <label>Hængelåse nummer</label>
            <input id="lock-number-step" type="text" placeholder="F.eks. 12345" style="width:100%;padding:8px;margin-top:8px;border-radius:8px;border:1px solid #f1dede" />
            <div id="lock-note" class="muted-note" style="margin-top:8px">Dette nummer gemmes med LOTO-registreringen.</div>
          </div>
        </div>

        <div id="step-2" class="step">
          <div style="font-weight:700;margin-bottom:6px">3. Tag billede af hængelåsen hvor du har igangsat LOTO</div>
          <div style="display:flex;gap:12px;align-items:flex-start;">
            <div style="flex:1;">
              <img id="capture-preview" src="" alt="Preview" style="display:none;width:100%;height:auto;border-radius:8px;background:#fff6f6" />
              <div id="photo-placeholder" class="photo-fallback" style="display:flex;align-items:center;justify-content:center">Ingen foto endnu</div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="take-photo-btn" class="btn">Tag foto</button>
                <button id="retake-photo" class="btn secondary" style="display:none">Tag igen</button>
              </div>
              <div id="upload-status" style="display:none;margin-top:8px" class="muted-note"></div>
            </div>

            <div style="width:320px;min-width:220px;">
              <div class="muted-note">Sørg for at låsen er synlig og nummeret kan aflæses på billedet.</div>
              <div style="margin-top:12px">
                <label>Operatør (auto)</label>
                <input id="operator-name" type="text" style="width:100%;margin-top:6px" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;gap:8px;margin-top:12px">
        <div>
          <button id="prev-step" class="btn secondary" disabled>Forrige</button>
        </div>
        <div style="display:flex;gap:8px">
          <button id="next-step" class="btn">Næste</button>
          <button id="abort-step" class="btn secondary">Annuller</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DETAILS MODAL -->
  <div id="details-modal" class="modal-backdrop" style="display:none" aria-hidden="true">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Detaljer</div>
        <button id="close-details" class="linklike">Luk</button>
      </div>

      <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;">
        <div style="flex:1;min-width:260px">
          <div style="font-weight:700" id="detail-lock-number">—</div>
          <div id="detail-sticker" class="small muted">—</div>
          <div style="margin-top:8px"><strong>Operatør</strong><div id="detail-operator" class="muted">—</div></div>
          <div style="margin-top:8px"><strong>Telefon</strong><div id="detail-phone" class="muted">—</div></div>
          <div style="margin-top:8px"><strong>Registreret</strong><div id="detail-createdAt" class="muted">—</div></div>
          <div id="details-actions" style="margin-top:12px"></div>
        </div>

        <div style="width:340px;min-width:220px">
          <img id="details-photo" src="" alt="Foto" style="display:none;width:100%;height:auto;border-radius:8px" />
          <div id="details-photo-fallback" class="photo-fallback" style="display:none">Ingen foto tilgængeligt</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + App script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp, query, where, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCZ1l12BC2ZowpgTgyOFX7QsuD9__0omFk",
      authDomain: "loto-app-ffa5a.firebaseapp.com",
      projectId: "loto-app-ffa5a",
      storageBucket: "loto-app-ffa5a.firebasestorage.app",
      messagingSenderId: "90362528781",
      appId: "1:90362528781:web:e9809bbeb6b12160ea8144"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Helper functions & DOM refs (same as earlier)...
    function get(id){ return document.getElementById(id); }
    function phoneToEmail(phone){ const cleaned = phone.replace(/\s+/g,'').replace(/\+/g,'plus').replace(/[^a-zA-Z0-9_-]/g,''); return `${cleaned}@loto.local`; }
    function formatTimestamp(ts){ if(!ts) return ''; try{ const d = ts.toDate ? ts.toDate() : new Date(ts); const pad = n=>String(n).padStart(2,'0'); return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }catch(e){ return ''; } }

    const userName = get('user-name');
    const signupFormEl = get('signup-form');
    const loginFormEl = get('login-form');
    const startBtnEl = get('start-loto-btn');
    const modal = get('modal');
    const detailsModal = get('details-modal');
    const closeModalBtn = get('close-modal');
    const closeDetailsBtn = get('close-details');
    const video = get('video');
    const videoWrap = get('video-wrap');
    const scanCheck = get('scan-check');
    const canvasEl = get('canvas');
    const videoFallback = get('video-fallback');
    const flipBtn = get('flip-camera');
    const enableCameraBtn = get('enable-camera');
    const cameraStatus = get('camera-status');
    const scannerSupportWarning = get('scanner-support-warning');
    const scannedDataDisplay = get('scanned-data');
    const manualEquip = get('manual-equip');
    const operatorNameStep = get('operator-name');
    const lockNumberStep = get('lock-number-step');
    const capturePreview = get('capture-preview');
    const photoPlaceholder = get('photo-placeholder');
    const retakeBtn = get('retake-photo');
    const takePhotoBtn = get('take-photo-btn');
    const finalUploadStatus = get('upload-status');
    const locksListEl = get('locks-list');
    const detailLockNumber = get('detail-lock-number');
    const detailSticker = get('detail-sticker');
    const detailOperator = get('detail-operator');
    const detailPhone = get('detail-phone');
    const detailCreatedAt = get('detail-createdAt');
    const detailsPhoto = get('details-photo');
    const detailsPhotoFallback = get('details-photo-fallback');
    const detailsActions = get('details-actions');

    // State
    let currentUser = null;
    let stream = null;
    let usingFront = false;
    let unsubscribeLocks = null;
    let lastCreatedId = null;
    let pendingPhotoDataUrl = null;
    let lastScannedValue = null;

    // Stepper etc.
    let stepIndex = 0;
    const steps = [ get('step-0'), get('step-1'), get('step-2') ];
    const indicators = Array.from(document.querySelectorAll('.step-indicator'));
    const prevBtn = get('prev-step');
    const nextBtn = get('next-step');
    const abortBtn = get('abort-step');

    // Detector
    let detector = null;
    let scanActive = false;
    let scanFrameId = null;
    const scanCanvas = canvasEl;
    const scanCtx = scanCanvas ? scanCanvas.getContext('2d') : null;

    // Init detector (if supported)
    async function initDetector(){
      try{
        if(window.BarcodeDetector){
          detector = new BarcodeDetector({formats:['qr_code']});
          if(scannerSupportWarning) scannerSupportWarning.style.display='none';
        } else {
          detector = null;
          if(scannerSupportWarning) scannerSupportWarning.style.display='block';
        }
      } catch(e){ detector = null; if(scannerSupportWarning) scannerSupportWarning.style.display='block'; console.warn('detector init err', e); }
    }
    initDetector();

    // Visual feedback
    function triggerScanAnimation(){
      try{
        if(!video) return;
        video.classList.add('video-detect');
        if(scanCheck) scanCheck.classList.add('show');
        setTimeout(()=>{ video.classList.remove('video-detect'); }, 900);
        setTimeout(()=>{ if(scanCheck) scanCheck.classList.remove('show'); }, 900);
      } catch(e){ console.warn('scan anim err', e); }
    }

    // Camera control & scanning (as earlier)...
    async function startCamera(forcePrompt=false){
      try{
        if(stream && !forcePrompt){ if(cameraStatus) cameraStatus.textContent='Kamera aktiv'; await startScanningWithDetector(); return; }
        const constraints = { video: { facingMode: usingFront ? 'user' : 'environment', width:{ideal:1280}, height:{ideal:720} }, audio:false };
        if(stream) stopCamera();
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        if(video){ video.srcObject = stream; try{ await video.play(); } catch(e){} }
        if(videoFallback) videoFallback.style.display='none';
        if(cameraStatus) cameraStatus.textContent='Kamera aktiv';
        localStorage.setItem('cameraAllowed','true');
        await startScanningWithDetector();
      } catch(e){
        console.warn('startCamera err', e);
        if(videoFallback) videoFallback.style.display='block';
        if(cameraStatus) cameraStatus.textContent='Kamera ikke tilgængelig';
      }
    }
    function stopCamera(){ if(stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch(e){} stream=null; } if(video) video.srcObject=null; if(cameraStatus) cameraStatus.textContent=''; stopScanningLoop(); }

    async function startScanningWithDetector(){
      if(!video || !scanCanvas || !scanCtx) return;
      if(scanActive || !detector) return;
      scanActive = true;
      lastScannedValue = null;
      if(video.paused) try{ await video.play(); } catch(e){}

      const loop = async ()=>{
        try{
          if(!video || video.readyState < 2){ scanFrameId = requestAnimationFrame(loop); return; }
          const vw = video.videoWidth, vh = video.videoHeight;
          if(vw===0||vh===0){ scanFrameId = requestAnimationFrame(loop); return; }
          scanCanvas.width = vw; scanCanvas.height = vh;
          scanCtx.drawImage(video,0,0,vw,vh);
          try{
            const bitmap = await createImageBitmap(scanCanvas);
            const results = await detector.detect(bitmap);
            bitmap.close();
            if(results && results.length>0){
              const v = results[0].rawValue || results[0].rawData || '';
              if(v && v !== lastScannedValue){ lastScannedValue = v; onDetectedQR(v); }
            }
          } catch(err){
            // detection failed — continue, no fallback CDN used
          }
        } catch(e){ console.warn('scan loop err', e); }
        scanFrameId = requestAnimationFrame(loop);
      };
      scanFrameId = requestAnimationFrame(loop);
    }
    function stopScanningLoop(){ if(scanFrameId){ cancelAnimationFrame(scanFrameId); scanFrameId=null; } scanActive = false; }

    function onDetectedQR(value){
      if(!scannedDataDisplay) return;
      scannedDataDisplay.textContent = value;
      scannedDataDisplay.classList.remove('muted'); scannedDataDisplay.classList.add('scan-success');
      triggerScanAnimation();
      stopScanningLoop();
      setTimeout(()=>{ if(stepIndex===0) showStep(1); }, 600);
    }

    // Firestore list: client-side sort + overdue mark (>24h)
    function startListeningActiveLocks(){
      const locksRef = collection(db,'activeLocks');
      const q = query(locksRef, where('status','==','active'));
      if(unsubscribeLocks) unsubscribeLocks();
      unsubscribeLocks = onSnapshot(q, snapshot => {
        const items = [];
        snapshot.forEach(snap => items.push({ id: snap.id, data: snap.data() }));
        items.sort((a,b)=>{
          const ta = a.data.createdAt && a.data.createdAt.toDate ? a.data.createdAt.toDate().getTime() : 0;
          const tb = b.data.createdAt && b.data.createdAt.toDate ? b.data.createdAt.toDate().getTime() : 0;
          return tb - ta;
        });

        locksListEl.innerHTML = '';
        if(items.length===0){ locksListEl.innerHTML = '<div class="muted">Ingen aktive låse.</div>'; return; }

        items.forEach(item=>{
          const data = item.data; const id = item.id;
          const createdAtText = formatTimestamp(data.createdAt);
          const createdAtMs = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().getTime() : 0;
          const isOld = (Date.now() - createdAtMs) > (24*3600*1000);
          const isOwner = currentUser && data.createdBy === currentUser.uid;
          const el = document.createElement('div');
          el.className = 'lock';
          el.dataset.lockId = id;
          el.dataset.createdBy = data.createdBy || '';
          el.dataset.lockNumber = data.lockNumber || '';
          el.dataset.sticker = data.stickerData || '';
          el.dataset.operatorName = data.operatorName || '';

          const overdueHtml = isOld ? `<span class="overdue-badge">Over 24h</span>` : '';
          el.innerHTML = `
            <div class="col col-lock">
              <div class="primary">${data.lockNumber || '—'}</div>
              <div class="secondary">Låsenr.</div>
            </div>
            <div class="col col-sticker">
              <div class="primary">${data.stickerData || '—'}</div>
              <div class="secondary">Equipment</div>
            </div>
            <div class="col col-operator">
              <div class="primary">${data.operatorName || ''}</div>
              <div class="secondary">Registreret af</div>
            </div>
            <div class="col col-time">
              <div class="primary ${isOld ? 'time-overdue' : ''}">${createdAtText || '—'}</div>
              <div class="secondary">Tidspunkt</div>
            </div>
            <div class="col col-badge">
              <div class="badge">AKTIV</div>
              ${overdueHtml}
            </div>
          `;
          el.setAttribute('role','button'); el.setAttribute('tabindex','0');

          if(lastCreatedId && lastCreatedId === id){ el.classList.add('highlight'); setTimeout(()=>el.classList.remove('highlight'),3000); lastCreatedId = null; }

          el.addEventListener('click', ()=> openLockDetails(id));
          el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openLockDetails(id); } });
          locksListEl.appendChild(el);
        });
      }, err => console.error('Fejl i locks snapshot', err));
    }
    function stopListeningActiveLocks(){ if(unsubscribeLocks) unsubscribeLocks(); unsubscribeLocks = null; locksListEl.innerHTML=''; }

    // open details and release action with robust error handling
    async function openLockDetails(lockId){
      try{
        if(!lockId) return;
        if(detailLockNumber) detailLockNumber.textContent='—';
        if(detailSticker) detailSticker.textContent='—';
        if(detailOperator) detailOperator.textContent='—';
        if(detailPhone) detailPhone.textContent='';
        if(detailCreatedAt) detailCreatedAt.textContent='—';
        if(detailsPhoto){ detailsPhoto.style.display='none'; detailsPhoto.src=''; }
        if(detailsPhotoFallback) detailsPhotoFallback.style.display='none';
        if(detailsActions) detailsActions.innerHTML='';

        const lockDocRef = doc(db,'activeLocks',lockId);
        const lockSnap = await getDoc(lockDocRef);
        let photoField=null, sticker='', operatorNameLocal='';

        if(lockSnap.exists()){
          const d = lockSnap.data();
          sticker = d.stickerData || '';
          operatorNameLocal = d.operatorName || '';
          if(detailCreatedAt) detailCreatedAt.textContent = formatTimestamp(d.createdAt) || '—';
          photoField = d.photoURL || null;
          if(detailLockNumber) detailLockNumber.textContent = d.lockNumber || '—';
          if(detailSticker) detailSticker.textContent = sticker || '—';
          if(detailOperator) detailOperator.textContent = operatorNameLocal || '—';
        } else {
          const listEl = document.querySelector(`.lock[data-lock-id="${lockId}"]`);
          if(listEl){
            sticker = listEl.dataset.sticker || '';
            operatorNameLocal = listEl.dataset.operatorName || '';
            if(detailLockNumber) detailLockNumber.textContent = listEl.dataset.lockNumber || '—';
            if(detailSticker) detailSticker.textContent = sticker || '—';
            if(detailOperator) detailOperator.textContent = operatorNameLocal || '—';
          }
        }

        const resolvedUrl = await resolvePhotoDownloadUrl(lockId, photoField);
        if(resolvedUrl && detailsPhoto){ detailsPhoto.src=resolvedUrl; detailsPhoto.style.display='block'; if(detailsPhotoFallback) detailsPhotoFallback.style.display='none'; }
        else { if(detailsPhoto) detailsPhoto.style.display='none'; if(detailsPhotoFallback){ detailsPhotoFallback.style.display='block'; detailsPhotoFallback.textContent='Ingen foto tilgængeligt'; } }

        const createdBy = lockSnap.exists() ? (lockSnap.data().createdBy || '') : (document.querySelector(`.lock[data-lock-id="${lockId}"]`)?.dataset?.createdBy || '');
        if(createdBy){
          const userDoc = await getDoc(doc(db,'users',createdBy));
          if(userDoc.exists()){ const ud = userDoc.data(); if(detailOperator) detailOperator.textContent = ud.name || operatorNameLocal || '—'; if(detailPhone){ if(ud.phone) detailPhone.innerHTML=`<a href="tel:${ud.phone}">${ud.phone}</a>`; else detailPhone.textContent=''; } }
        }

        // show release only if current user is owner
        if(currentUser && createdBy && currentUser.uid === createdBy){
          const btn = document.createElement('button'); btn.className='btn secondary'; btn.textContent='Frigiv';
          btn.addEventListener('click', async ()=>{
            if(!confirm('Vil du frigive denne lås?')) return;
            try{
              await updateDoc(doc(db,'activeLocks',lockId), { status:'released', releasedBy: currentUser.uid, releasedAt: serverTimestamp() });
              closeDetailsModal();
            } catch(err){
              console.error('Release error', err);
              if(err && err.code === 'permission-denied'){
                alert('Du har ikke tilladelse til at frigive denne lås. Tjek Firestore-rules eller kontakt administrator.');
              } else {
                alert('Fejl ved frigivelse: ' + (err.message || err));
              }
            }
          });
          if(detailsActions) detailsActions.appendChild(btn);
        } else {
          if(detailsActions) detailsActions.innerHTML = '<div class="locked-note">Kun skaberen kan frigive denne lås</div>';
        }

        // open details modal
        if(detailsModal){ detailsModal.style.display='flex'; detailsModal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
      } catch(err){ console.error('openLockDetails err', err); alert('Fejl ved åbning af detaljer: ' + (err.message || err)); }
    }

    // resolve photo
    async function resolvePhotoDownloadUrl(docId, photoField){
      try{
        if(!photoField && !docId) return null;
        if(photoField && (photoField.startsWith('http://') || photoField.startsWith('https://'))){
          try{ const u = new URL(photoField); if(u.searchParams.has('token')) return photoField; } catch(e){ return photoField; }
        }
        if(photoField && photoField.startsWith('gs://')){
          const parts = photoField.split('/'); const path = parts.slice(3).join('/');
          if(path) return await getDownloadURL(storageRef(storage, path));
        }
        if(photoField && photoField.includes('/v0/b/')){
          try{ const url = new URL(photoField); const o = url.searchParams.get('o'); if(o) return await getDownloadURL(storageRef(storage, decodeURIComponent(o))); }catch(e){}
        }
        if(docId){
          try{ return await getDownloadURL(storageRef(storage, `activeLocks/${docId}/photo.jpg`)); } catch(e){ console.warn(e); }
        }
      } catch(err){ console.error('resolvePhotoDownloadUrl', err); }
      return null;
    }

    // Auth & forms (same as before)
    if (signupFormEl) signupFormEl.addEventListener('submit', async e => {
      e.preventDefault();
      const name = get('input-name')?.value?.trim();
      const pwd = get('input-password')?.value;
      const phone = get('input-phone')?.value?.trim();
      if(!name||!pwd||!phone){ alert('Udfyld alle felter'); return; }
      try {
        const uc = await createUserWithEmailAndPassword(auth, phoneToEmail(phone), pwd);
        await updateProfile(uc.user, { displayName: name });
        await setDoc(doc(db,'users',uc.user.uid), { name, phone, createdAt: serverTimestamp() });
      } catch(err) { console.error(err); alert('Fejl: '+err.message); }
    });

    if (loginFormEl) loginFormEl.addEventListener('submit', async e => {
      e.preventDefault();
      const phone = get('login-phone')?.value?.trim();
      const pwd = get('login-password')?.value;
      if(!phone||!pwd){ alert('Udfyld alle felter'); return; }
      try { await signInWithEmailAndPassword(auth, phoneToEmail(phone), pwd); } catch(err){ console.error(err); alert('Login fejlede: '+err.message); }
    });

    get('signout-btn')?.addEventListener('click', async ()=> { try{ await signOut(auth); } catch(e){ console.error(e); } });

    onAuthStateChanged(auth, user => {
      currentUser = user || null;
      if (user) {
        if (userName) userName.textContent = user.displayName || user.email || '';
        get('user-area') && (get('user-area').style.display = 'flex');
        get('auth-card') && (get('auth-card').style.display = 'none');
        get('app-view') && (get('app-view').style.display = 'block');
        startListeningActiveLocks();
        if(operatorNameStep && !operatorNameStep.value.trim()) operatorNameStep.value = user.displayName || '';
      } else {
        if (userName) userName.textContent = '';
        get('user-area') && (get('user-area').style.display = 'none');
        get('auth-card') && (get('auth-card').style.display = 'block');
        get('app-view') && (get('app-view').style.display = 'none');
        stopListeningActiveLocks();
      }
    });

    // Stepper & save flow (same as before)...
    function showStep(idx){
      if(idx<0||idx>=steps.length) return;
      steps.forEach((s,i)=> s.classList.toggle('active', i===idx));
      indicators.forEach((ind,i)=> ind.classList.toggle('active', i===idx));
      stepIndex = idx;
      prevBtn.disabled = (stepIndex===0);
      nextBtn.textContent = (stepIndex === steps.length-1) ? 'Gem' : 'Næste';
      const activeStep = steps[idx]; if(activeStep){
        const focusable = activeStep.querySelector('input,button,select,textarea,[tabindex]:not([tabindex="-1"])');
        if(focusable) try{ focusable.focus(); } catch(e){}
      }
      if(idx !== 0) stopScanningLoop();
    }
    prevBtn?.addEventListener('click', ()=> { if(stepIndex>0) showStep(stepIndex-1); });
    abortBtn?.addEventListener('click', ()=> { closeModalFunc(); });

    nextBtn?.addEventListener('click', async ()=> {
      if(stepIndex===0){
        const scanned = (scannedDataDisplay && scannedDataDisplay.textContent && scannedDataDisplay.textContent.trim() && scannedDataDisplay.textContent.trim()!=='Ingen scanning endnu') ? scannedDataDisplay.textContent.trim() : null;
        const manual = manualEquip && manualEquip.value.trim() ? manualEquip.value.trim() : null;
        if(!scanned && !manual){ alert('Scan QR eller indtast equipment-nummer manuelt for at fortsætte.'); return; }
        if(!scanned && manual){ scannedDataDisplay.textContent = manual; scannedDataDisplay.classList.remove('muted'); scannedDataDisplay.classList.add('scan-success'); }
        showStep(stepIndex+1);
      } else if(stepIndex===1){
        const ln = lockNumberStep && lockNumberStep.value.trim();
        if(!ln){ alert('Indtast låsens nummer for at fortsætte.'); return; }
        showStep(stepIndex+1);
      } else if(stepIndex===2){
        if(!pendingPhotoDataUrl){ alert('Tag et foto af låsen før du gemmer.'); return; }
        try{
          if(!auth.currentUser){ alert('Du skal være logget ind'); return; }
          const op = operatorNameStep?.value?.trim() || '';
          const ln = lockNumberStep?.value?.trim() || '';
          const sticker = scannedDataDisplay?.textContent?.trim() || (manualEquip && manualEquip.value.trim()) || '';
          if(!op||!ln){ alert('Udfyld navn og lås'); return; }
          stopCamera(); closeModalFunc();
          if(finalUploadStatus) { finalUploadStatus.style.display='block'; finalUploadStatus.textContent='Opretter...'; }
          const newDocRef = await addDoc(collection(db,'activeLocks'), {
            operatorName:op, lockNumber:ln, stickerData:sticker,
            createdBy:auth.currentUser.uid, createdByName:auth.currentUser.displayName||'',
            createdAt: serverTimestamp(), status:'active'
          });
          const blob = await (await fetch(pendingPhotoDataUrl)).blob();
          const sRef = storageRef(storage, `activeLocks/${newDocRef.id}/photo.jpg`);
          try{ await uploadBytes(sRef, blob); } catch(storageErr){ console.error('Upload failed', storageErr); await updateDoc(newDocRef, { status:'upload_failed' }).catch(()=>{}); alert('Upload fejlede: '+(storageErr.message||storageErr.code)); if(finalUploadStatus) finalUploadStatus.style.display='none'; return; }
          const url = await getDownloadURL(sRef);
          await updateDoc(newDocRef, { photoURL: url, photoUploadedAt: serverTimestamp() });
          lastCreatedId = newDocRef.id; pendingPhotoDataUrl=null; if(finalUploadStatus) finalUploadStatus.style.display='none';
          setTimeout(()=> focusNewLock(lastCreatedId), 900);
        } catch(err){ console.error('Save error', err); alert('Fejl: ' + (err.message||err)); }
      }
    });

    function openModal(){ if(!modal){ alert('Modal mangler i DOM'); return; } modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; scannedDataDisplay.textContent='Ingen scanning endnu'; scannedDataDisplay.classList.add('muted'); scannedDataDisplay.classList.remove('scan-success'); manualEquip.value=''; operatorNameStep.value = currentUser ? (currentUser.displayName||'') : ''; lockNumberStep.value=''; pendingPhotoDataUrl=null; capturePreview.style.display='none'; capturePreview.src=''; photoPlaceholder.style.display='flex'; retakeBtn.style.display='none'; showStep(0); const pref = localStorage.getItem('cameraAllowed'); if(pref==='true'){ startCamera(false); } else { if(cameraStatus) cameraStatus.textContent='Klik \"Start kamera\" for at give adgang'; } }
    function closeModalFunc(){ if(modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; } stopCamera(); lastScannedValue=null; }

    // close details modal
    function closeDetailsModal(){ if(detailsModal){ detailsModal.style.display='none'; detailsModal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; } }
    closeDetailsBtn && closeDetailsBtn.addEventListener('click', closeDetailsModal);
    detailsModal && detailsModal.addEventListener('click', (e)=>{ if(e.target===detailsModal) closeDetailsModal(); });

    // camera bindings
    enableCameraBtn?.addEventListener('click', async ()=>{ await initDetector(); await startCamera(true); });
    flipBtn?.addEventListener('click', async ()=>{ usingFront = !usingFront; await startCamera(true); });

    // photo capture bindings
    takePhotoBtn?.addEventListener('click', async ()=>{ if(!video){ alert('Start kamera først'); return; } if(!stream){ alert('Start kamera først'); return; } const vw = video.videoWidth, vh = video.videoHeight; if(vw===0||vh===0){ alert('Kamera ikke klar'); return; } if(!scanCanvas || !scanCtx){ alert('Intern fejl: canvas ikke sat op'); return; } scanCanvas.width = vw; scanCanvas.height = vh; scanCtx.drawImage(video,0,0,vw,vh); const dataUrl = scanCanvas.toDataURL('image/jpeg',0.9); pendingPhotoDataUrl = dataUrl; capturePreview.src = dataUrl; capturePreview.style.display='block'; photoPlaceholder.style.display='none'; retakeBtn.style.display='inline-block'; });
    retakeBtn?.addEventListener('click', ()=>{ pendingPhotoDataUrl=null; capturePreview.src=''; capturePreview.style.display='none'; photoPlaceholder.style.display='flex'; retakeBtn.style.display='none'; });

    // start bindings
    startBtnEl && startBtnEl.addEventListener('click', ()=> openModal());
    closeModalBtn && closeModalBtn.addEventListener('click', ()=> closeModalFunc());
    modal && modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModalFunc(); });

    function focusNewLock(id){ if(!id) return; const el=document.querySelector(`.lock[data-lock-id="${id}"]`); if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}); el.classList.add('highlight'); setTimeout(()=>el.classList.remove('highlight'),3000); } }

    // Start UI
    showStep(0);
    console.log('App initialized (fixed): BarcodeDetector-only fallback, green AKTIV badge, safer release handling.');

  </script>
</body>
</html>
